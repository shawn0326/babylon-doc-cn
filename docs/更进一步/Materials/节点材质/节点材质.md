节点材质
===

节点材料是一种简单的、高度可定制的材质，您可以一块一块地自己构建。结合强大的基于节点的编辑器，您可以轻松地为您的 Babylon.js 场景创建令人惊叹的自定义 GPU 着色器和特效。

通过节点材质您可以避免编写复杂的着色器语言代码，而是使用可视化交互（节点材质编辑器）或在场景代码中创建和连接节点块（节点材质块）。

要开始使用，了解节点材质的底层工作原理很重要，首先要学习如何使用代码创建节点材质。

### 使用代码创建一个节点材质

#### 第一步

如果您有兴趣学习如何通过代码创建节点材质，您可以考虑从下面的视频开始，因为它包含 3 个重要提示来帮助您入门：

*小贴士：视频可以开启智能翻译哦~*

<iframe width="800" height="450" src="https://www.youtube.com/embed/GrmVObi6caQ" title="Creating Procedural Node Materials Through Code" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

要开始使用节点材质，您只需要实例化一个：

````javascript
const nodeMaterial = new BABYLON.NodeMaterial("node material", scene, { emitComments: true });
````

请注意，第三个参数将包含可选值，可让您配置材质如何构建其着色器：

* emitComments: 如果您希望块在着色器代码中包含注释，请将此值设置为 true

#### 添加Blocks

实例化Blocks：

````javascript
const morphTargets = new BABYLON.MorphTargetsBlock("morphTargets");
````

对于输入块，您可以定义它们的值或值的来源：

````javascript
const timeInput = new BABYLON.InputBlock("time");
timeInput.value = 0;
````

或者：

````javascript
const viewProjectionInput = new BABYLON.InputBlock("viewProjection");
viewProjectionInput.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);
````

系统内置变量包含：

* BABYLON.NodeMaterialSystemValues.World
* BABYLON.NodeMaterialSystemValues.View
* BABYLON.NodeMaterialSystemValues.WorldView
* BABYLON.NodeMaterialSystemValues.Projection
* BABYLON.NodeMaterialSystemValues.ViewProjection
* BABYLON.NodeMaterialSystemValues.WorldViewProjection
* BABYLON.NodeMaterialSystemValues.CameraPosition
* BABYLON.NodeMaterialSystemValues.FogColor
* BABYLON.NodeMaterialSystemValues.DeltaTime

输入块也可以从网格属性中获取它们的值：

````javascript
let positionInput = new BABYLON.InputBlock("position");
positionInput.setAsAttribute("position");
````

Attributes类型包括：

* position
* normal
* tangent
* uv
* uv2
* matricesIndices
* matricesWeights
* matricesIndicesExtra
* matricesWeightsExtra

当您手动设置 InputNode 的值时，您可以将其标记为 `node.isConstant` 以指示该值不会动态更新，因此节点材质将能够通过不为此值生成Uniform来优化该Block。

以下函数将使您获得有关 InputNode 的信息：

* isSystemValue
* isAttribute
* isUniform
* isConstant

当 InputNode 是Uniform（例如，发送到着色器的自定义值）而不是常量时，您可以将 `inputNode.visibleInInspector` 设置为 `true` 以便用户能够使用 Babylon.js 调试器可视化地控制节点的值。

您甚至可以通过定义 `inputNode.min` 和 `inputNode.max` 来自定义 Inspector UI 的外观和类型，以获取滑块而不是输入文本框。

#### 链接Blocks

默认情况下，调用 `block.connectTo(otherBlock)` 将尝试通过从第一个块中选择一个输出并将其连接到第二个块中可用的输入：

````javascript
const positionInput = new BABYLON.InputBlock("position");
positionInput.setAsAttribute("position");

const worldInput = new BABYLON.InputBlock("world");
worldInput.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);

const worldPos = new BABYLON.TransformBlock("worldPos");
positionInput.connectTo(worldPos);
worldInput.connectTo(worldPos);
````

如果您不想使用自动连接，您可以选择要直接连接的输出和输入：

````javascript
worldInput.output.connectTo(boneBlock.world);
````

您可以检查两个连接点是否可以连接:

````javascript
if (worldInput.output.canConnectTo(boneBlock.world)) {
    ...
}
````

如果您尝试连接两个不兼容的连接点，系统将抛出异常。

当两个连接点已经连接时，可以这样断开：

````javascript
worldInput.output.disconnectFrom(boneBlock.world);
````

#### 获取Blocks

在 NodeMaterial 中构建图表后，您可以使用以下 API 按名称获取特定节点：

````javascript
let block = nodeMaterial.getBlockByName("MyBlock");
````

您还可以使用查询逻辑获取块：

````javascript
let block = nodeMaterial.getInputBlockByPredicate((b) => b.name === "foo");
block.value = 10;
````

请注意，虽然此 API 通常适用于所有输入块，但并非所有输入块都具有“值”属性。例如，纹理块将具有 block.texture 而不是 block.value。请务必查看[API 文档](https://doc.babylonjs.com/typedoc/classes/BABYLON.NodeMaterial)以获取详细信息。

您可以通过以下方式访问 InputBlocks 列表：

````javascript
nodeMaterial.getInputBlocks();
````

或者你可以获取所有到注册到一个节点材质上的Block：

````javascript
nodeMaterial.attachedBlocks;
````

请务必查看完整的[API 文档](https://doc.babylonjs.com/typedoc/classes/BABYLON.NodeMaterial)。

#### 构建节点材质

设置完成后，您可以通过调用 nodeMaterial.build(true) 要求节点材质构建其内部着色器（顶点和片段）。您可以将布尔参数设置为 true 以在控制台上获取最终着色器的日志。

如果无法编译着色器，构建函数将抛出异常：

````javascript
try {
  nodeMaterial.build(true);
} catch (err) {
  console.log("Unable to compile because " + err);
}
````

成功构建后，您可以像使用任何其他材质一样使用节点材质：

````javascript
myMesh.material = nodeMaterial;
````

#### 示例

这是使用节点材质的最简单的代码之一：

````javascript
const nodeMaterial = new BABYLON.NodeMaterial("node material", scene, { emitComments: true });
const positionInput = new BABYLON.InputBlock("position");
positionInput.setAsAttribute("position");

const worldInput = new BABYLON.InputBlock("world");
worldInput.setAsSystemValue(BABYLON.NodeMaterialSystemValues.World);

const worldPos = new BABYLON.TransformBlock("worldPos");
positionInput.connectTo(worldPos);
worldInput.connectTo(worldPos);

const viewProjectionInput = new BABYLON.InputBlock("viewProjection");
viewProjectionInput.setAsSystemValue(BABYLON.NodeMaterialSystemValues.ViewProjection);

const worldPosdMultipliedByViewProjection = new BABYLON.TransformBlock("worldPos * viewProjectionTransform");
worldPos.connectTo(worldPosdMultipliedByViewProjection);
viewProjectionInput.connectTo(worldPosdMultipliedByViewProjection);

const vertexOutput = new BABYLON.VertexOutputBlock("vertexOutput");
worldPosdMultipliedByViewProjection.connectTo(vertexOutput);

// Pixel
const pixelColor = new BABYLON.InputBlock("color");
pixelColor.value = new BABYLON.Color4(0.8, 0.8, 0.8, 1);

const fragmentOutput = new BABYLON.FragmentOutputBlock("fragmentOutput");
pixelColor.connectTo(fragmentOutput);

// Add to nodes
nodeMaterial.addOutputNode(vertexOutput);
nodeMaterial.addOutputNode(fragmentOutput);
````

请注意，此代码等效于：

````javascript
const nodeMaterial = new BABYLON.NodeMaterial("node material", scene, { emitComments: true });
nodeMaterial.setToDefault();
````

这是手动创建令人印象深刻的节点材质的高级且出色的示例。

[高级溶解节点材质](https://playground.babylonjs.com/#GETMGI#2)

### 使用节点材质编辑器

// TODO
